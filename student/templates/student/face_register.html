

<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<div class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-600 flex items-center justify-center p-6">

    <div class="bg-white/10 backdrop-blur-xl shadow-2xl rounded-3xl w-full max-w-md p-8 text-center border border-white/20">

        <h2 class="text-2xl font-bold text-white mb-2">
            Face Registration
        </h2>

        <p class="text-white/80 mb-6">
            {{ user.Name }} ({{ user.Roll_no }})
        </p>

        <!-- Camera Circle -->
        <div class="relative w-56 h-56 mx-auto mb-6">
            <video id="video"
                autoplay
                class="w-56 h-56 object-cover rounded-full border-4 border-white shadow-lg">
            </video>

            <!-- Scanning animation ring -->
            <div id="scanRing"
                class="absolute inset-0 rounded-full border-4 border-cyan-400 animate-pulse hidden">
            </div>
        </div>

        <!-- Capture Button -->
        <button id="captureBtn"
            onclick="captureFace()"
            class="w-full bg-white text-indigo-600 font-semibold py-3 rounded-xl shadow-lg hover:scale-105 transition duration-300">
            Capture Face
        </button>

        <!-- Progress Section -->
        <div id="progressSection" class="hidden mt-6">

            <div class="w-full bg-white/30 rounded-full h-3 overflow-hidden">
                <div id="progressBar"
                    class="bg-cyan-400 h-3 rounded-full transition-all duration-300"
                    style="width:0%">
                </div>
            </div>

            <p id="progressText" class="text-white mt-3 text-sm">
                Processing...
            </p>
        </div>

        <!-- Success -->
        <div id="successSection" class="hidden mt-6 text-green-300 font-semibold text-lg">
            âœ… Face Registered Successfully
        </div>

    </div>
</div>


<script>

const video = document.getElementById("video");
const captureBtn = document.getElementById("captureBtn");
const progressSection = document.getElementById("progressSection");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const successSection = document.getElementById("successSection");
const scanRing = document.getElementById("scanRing");

let streamRef = null;

// Start camera
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
    video.srcObject = stream;
    streamRef = stream;
});

function updateProgress(percent, text) {
    progressBar.style.width = percent + "%";
    progressText.innerText = text;
}

function captureFace() {

    captureBtn.disabled = true;
    scanRing.classList.remove("hidden");
    progressSection.classList.remove("hidden");

    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    context.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL("image/jpeg");

    // Fake smooth progress animation
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        updateProgress(progress, "Analyzing facial features...");
        if (progress >= 80) clearInterval(interval);
    }, 200);

    fetch("{% url 'save_face' user.Roll_no %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ image: imageData })
    })
    .then(res => res.json())
    .then(data => {

        clearInterval(interval);
        updateProgress(100, "Finalizing...");

        setTimeout(() => {

            if (data.status === "success") {

                // Stop camera
                if (streamRef) {
                    streamRef.getTracks().forEach(track => track.stop());
                }

                scanRing.classList.add("hidden");
                progressSection.classList.add("hidden");
                successSection.classList.remove("hidden");

                // Redirect after 2.5 seconds
                setTimeout(() => {
                    window.location.href = "{% url 'student_login' %}";
                }, 2500);

            } else {
                alert(data.message);
                captureBtn.disabled = false;
                scanRing.classList.add("hidden");
            }

        }, 800);

    });
}

</script>



