{% include 'tailwind.html' %}

{% include 'student/messages.html' %}
{% load widget_tweaks %}

<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-indigo-200 p-6">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">

        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">OLMS</h1>
            <p class="text-sm text-gray-500">Online Library Management System</p>
        </div>

        <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">
            Student Login
        </h2>

        <form action="{% url 'student_login' %}" method="POST" class="space-y-5">
            {% csrf_token %}

            <!-- Username -->
            <div>
                {{ forms.email.label_tag }}
                {{ forms.email | add_class:"w-full px-3 py-2 border border-gray-400 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
            </div>

            <!-- Password -->
            <div>
                {{ forms.Password.label_tag }}
                {{ forms.Password }}
            </div>

            <button type="submit"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg shadow">
                Login
            </button>
            <div class="relative flex items-center my-4">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="mx-3 text-gray-400 text-sm">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <button type="button" onclick="startFaceLogin()"
                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2.5 rounded-lg shadow">
                Login with Face
            </button>


            <p class="text-center text-sm text-gray-600">
                Don’t have an account?
                <a href="{% url 'register' %}" class="text-indigo-600 hover:underline">
                    Register
                </a>
            </p>

        </form>

    </div>
</div>


<div id="faceModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">

    <div class="bg-white rounded-3xl w-96 p-8 text-center shadow-2xl relative animate-fadeIn">

        <h3 class="text-xl font-semibold mb-6 text-gray-800">
            Face Authentication
        </h3>

        <!-- Camera Container -->
        <div class="relative w-56 h-56 mx-auto mb-6">

            <video id="video" autoplay class="w-56 h-56 object-cover rounded-full border-4 border-indigo-500 shadow-lg">
            </video>

            <!-- Rotating detection ring -->
            <div id="scanRing"
                class="absolute inset-0 rounded-full border-4 border-emerald-400 animate-spin-slow hidden">
            </div>

            <!-- Pulse glow -->
            <div id="scanGlow" class="absolute inset-0 rounded-full bg-emerald-400/20 animate-pulse hidden">
            </div>

        </div>

        <p id="statusText" class="text-sm text-gray-500 mb-3">
            Align your face inside the circle
        </p>
        <!-- Progress Bar -->
        <div id="progressContainer" class="hidden mt-4">
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="progressBar" class="bg-emerald-500 h-2 rounded-full transition-all duration-200"
                    style="width: 0%">
                </div>
            </div>
            <p id="progressPercent" class="text-xs text-gray-500 mt-1">0%</p>
        </div>


        <p id="faceMessage" class="text-red-500 text-sm mb-3 hidden">
        </p>

        <button id="verifyBtn" onclick="captureFaceLogin()"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg shadow transition">
            Verify Face
        </button>

        <button onclick="closeModal()" class="mt-3 text-gray-500 text-sm hover:underline">
            Cancel
        </button>

    </div>
</div>


<style>
    @keyframes spinSlow {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .animate-spin-slow {
        animation: spinSlow 3s linear infinite;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
    }
</style>



<script>

    let streamRef = null;

    function startFaceLogin() {

        const email = document.getElementById("id_email").value;

        if (!email) {
            alert("Enter email first");
            return;
        }

        document.getElementById("faceModal").classList.remove("hidden");

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                document.getElementById("video").srcObject = stream;
                streamRef = stream;
            });
    }

   function captureFaceLogin() {

    const email = document.getElementById("id_email").value;

    const video = document.getElementById("video");
    const statusText = document.getElementById("statusText");
    const message = document.getElementById("faceMessage");
    const scanRing = document.getElementById("scanRing");
    const scanGlow = document.getElementById("scanGlow");
    const verifyBtn = document.getElementById("verifyBtn");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const progressPercent = document.getElementById("progressPercent");

    message.classList.add("hidden");
    verifyBtn.disabled = true;

    scanRing.classList.remove("hidden");
    scanGlow.classList.remove("hidden");
    progressContainer.classList.remove("hidden");

    statusText.innerText = "Analyzing facial features...";

    // ---- Simulated Real-Time Progress ----
    let progress = 0;

    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 8;  // random smooth increments
            progress = Math.min(progress, 90);
            progressBar.style.width = progress + "%";
            progressPercent.innerText = Math.floor(progress) + "%";
        }
    }, 200);

    // Capture frame
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL("image/jpeg");

    fetch("{% url 'face_login' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
            image: imageData,
            email: email
        })
    })
    .then(res => res.json())
    .then(data => {

        clearInterval(progressInterval);

        // Finish progress smoothly to 100%
        let finalProgress = progress;
        const finishInterval = setInterval(() => {
            finalProgress += 5;
            progressBar.style.width = finalProgress + "%";
            progressPercent.innerText = Math.floor(finalProgress) + "%";

            if (finalProgress >= 99) {
                clearInterval(finishInterval);

                if (data.status === "success") {

                    statusText.innerText = "Face verified successfully";

                    if (streamRef) {
                        streamRef.getTracks().forEach(track => track.stop());
                    }

                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 800);

                } else {

                    scanRing.classList.add("hidden");
                    scanGlow.classList.add("hidden");

                    statusText.innerText = "Face not recognized";
                    message.innerText = "Face not recognized — Please login using password.";
                    message.classList.remove("hidden");

                    verifyBtn.disabled = false;

                    if (streamRef) {
                        streamRef.getTracks().forEach(track => track.stop());
                    }
                }
            }

        }, 500);
    });
}

    function closeModal() {

        if (streamRef) {
            streamRef.getTracks().forEach(track => track.stop());
        }

        document.getElementById("faceModal").classList.add("hidden");
    }

</script>