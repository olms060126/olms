{% include 'stdfeature.html' %}

<div class="min-h-screen bg-light text-white px-6 py-10 space-y-12">

    <!-- Welcome -->
    <div>
        <h1 class="text-3xl font-semibold">Welcome, {{ student.Name }}</h1>
        <p class="text-gray-400 text-sm mt-1">
            Explore books by genre and manage your activity
        </p>
    </div>

    
    <!--  ACTIVITY SUMMARY  -->

    <div class="space-y-6">

        <h2 class="text-2xl font-semibold">Your Activity</h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

            <div class="bg-white text-black rounded-xl p-6 text-center shadow">
                <p class="text-sm text-gray-500">Total Reserved</p>
                <p class="text-2xl font-bold mt-2">
                    {{ total_reserved }}
                </p>
            </div>

            <div class="bg-white text-black rounded-xl p-6 text-center shadow">
                <p class="text-sm text-gray-500">Books Issued</p>
                <p class="text-2xl font-bold mt-2">
                    {{ total_issued }}
                </p>
            </div>

            <div class="bg-white text-black rounded-xl p-6 text-center shadow">
                <p class="text-sm text-gray-500">Fines Paid</p>
                <p class="text-2xl font-bold mt-2">
                    ₹ {{ total_fine_paid }}
                </p>
            </div>

            <div class="bg-white text-black rounded-xl p-6 text-center shadow">
                <p class="text-sm text-gray-500">Pending Fines</p>
                <p class="text-2xl font-bold mt-2 text-red-600">
                    ₹ {{ pending_fines }}
                </p>
            </div>

        </div>

    </div>
    <!--Search bar-->
    <div>
        <form method="get" action="{% url 'sthome' %}" class="flex max-w-md mx-auto">
            <input type="text" name="q" placeholder="Search books..."
                class="w-full px-4 text-green-500 py-2 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg">
                Search
            </button>
        </form>

    </div>

    <!--  GENRE SECTIONS-->

    {% for genre, books in books_by_genre.items %}

    <div class="space-y-6">

        <!-- Genre Header -->
        <div class="flex justify-between items-center">
            <h2 class="text-2xl text-green-600 font-semibold tracking-wide">
                {{ genre }}
            </h2>

            <!-- <a href="" class="text-sm text-gray-400 hover:text-black transition">
                Show All →
            </a> -->
        </div>

        <!-- Horizontal Scroll Cards -->
        <div class="flex gap-6 overflow-x-auto pb-4">

            {% for book in books %}
            <div class="min-w-[200px] bg-white text-black rounded-xl shadow-lg overflow-hidden">

                <!-- Cover -->
                <div class="h-60 bg-gray-200">
                    <img src="{{ book.cover.url }}" class="w-full h-full object-cover">
                </div>

                <!-- Info -->
                <div class="p-4 space-y-2">

                    <h3 class="font-semibold truncate">
                        {{ book.Book_name }}
                    </h3>

                    <p class="text-xs text-gray-500 truncate">
                        {{ book.Authors_name }}
                    </p>

                    <!-- Availability -->
                    {% if book.available_copies > 0 %}
                    <span class="text-green-600 text-xs font-medium">
                        Available ({{ book.available_copies }})
                    </span>
                    {% else %}
                    <span id="availability-{{ book.id }}" class="text-green-600 text-xs font-medium">
                        Available ({{ book.available_copies }})
                    </span>

                    {% endif %}

                    <!-- Reservation Button -->
                    <div class="pt-2">
                        {% if book.is_reserved %}
                        <button
                            class="w-full py-2 rounded-lg bg-gray-300 text-gray-600 text-sm font-semibold cursor-not-allowed">
                            Already Reserved
                        </button>
                        {% else %}
                        <button 
                        data-url="{% url 'ajax_reserve_book' book.id %}"
                        class="reserve-btn w-full py-2 rounded-lg
         bg-black text-white text-sm font-semibold
         hover:bg-gray-800 transition" data-book-id="{{ book.id }}">
                            Reserve
                        </button>

                        {% endif %}
                    </div>

                </div>
            </div>
            {% endfor %}

        </div>

    </div>

    {% endfor %}

    <!--  POSSESSION  -->

    <div class="space-y-6">

    <h2 class="text-2xl font-semibold">
        Books in Your Possession
    </h2>

    {% if student_transactions %}

    <div class="relative">

        <!-- Scroll Buttons -->
        <button onclick="scrollLeft()"
                class="absolute left-0 top-1/2 -translate-y-1/2
                       bg-black text-white p-2 rounded-full z-10">
            ←
        </button>

        <button onclick="scrollRight()"
                class="absolute right-0 top-1/2 -translate-y-1/2
                       bg-black text-white p-2 rounded-full z-10">
            →
        </button>

        <!-- Carousel Container -->
        <div id="bookCarousel"
             class="flex gap-6 overflow-x-auto scroll-smooth
                    snap-x snap-mandatory
                    pb-4">

            {% for txn in student_transactions %}
            <div class="min-w-[280px] snap-start
                        bg-white text-black rounded-2xl
                        shadow-lg hover:shadow-xl
                        transition p-4 space-y-3">

                <!-- Book Cover -->
                <div class="h-40 w-full overflow-hidden rounded-xl">
                    <img src="{{ txn.Access_no.book.cover.url }}"
                         class="h-full w-full object-cover"
                         alt="Book Cover">
                </div>

                <!-- Book Info -->
                <h3 class="font-semibold text-lg">
                    {{ txn.Access_no.book.Book_name }}
                </h3>

                <p class="text-sm text-gray-500">
                    {{ txn.Access_no.book.Authors_name }}
                </p>

                <div class="text-sm space-y-1">

                    <p>
                        Issued:
                        <span class="font-medium">
                            {{ txn.issued_on|date:"M d, Y" }}
                        </span>
                    </p>

                    <p>
                        Due:
                        <span class="font-medium">
                            {{ txn.Due_date|date:"M d, Y" }}
                        </span>
                    </p>

                    <p>
                        Fine:
                        {% if txn.fine_table and not txn.fine_table.paid %}
                            <span class="text-red-600 font-semibold">
                                ₹ {{ txn.fine_table.amount_payable }}
                            </span>
                        {% else %}
                            <span class="text-green-600 font-medium">
                                ₹ 0
                            </span>
                        {% endif %}
                    </p>

                </div>

                <!-- Status -->
                <div>
                    {% if txn.returned %}
                        <span class="px-3 py-1 text-xs rounded-full
                                     bg-green-100 text-green-700">
                            Returned
                        </span>
                    {% else %}
                        <span class="px-3 py-1 text-xs rounded-full
                                     bg-red-100 text-red-700">
                            Active
                        </span>
                    {% endif %}
                </div>

            </div>
            {% endfor %}

        </div>

    </div>

    {% else %}
        <p class="text-gray-400">
            No books currently issued.
        </p>
    {% endif %}

</div>



</div>


<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function scrollLeft() {
    document.getElementById("bookCarousel")
        .scrollBy({ left: -320, behavior: "smooth" });
}

function scrollRight() {
    document.getElementById("bookCarousel")
        .scrollBy({ left: 320, behavior: "smooth" });
}

document.querySelectorAll(".reserve-btn").forEach(button => {

  button.addEventListener("click", function () {

    const bookId = this.dataset.bookId;
    const btn = this;
    const availability = document.getElementById(`availability-${bookId}`);
    const url = this.dataset.url;
    btn.disabled = true;
    btn.innerText = "Processing...";

    fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/json"
      }
    })
    .then(response => response.json())
    .then(data => {

      if (data.success) {
        window.location.reload();
        btn.innerText = "Already Reserved";
        btn.classList.remove("bg-black");
        btn.classList.add("bg-gray-400");
        btn.disabled = true;

        availability.innerText =
          `Available (${data.available_copies})`;

      } else {
        btn.innerText = data.error;
        setTimeout(() => {
          btn.innerText = "Reserve";
          btn.disabled = false;
        }, 2000);
      }

    })
    .catch(() => {
      btn.innerText = "Error";
      btn.disabled = false;
    });

  });

});
</script>
